# Основная программа - Калькулятор матриц на Nim
# Консольное приложение для выполнения операций с матрицами

# Импорт необходимых модулей:
# - matrix_operations: наш собственный модуль с матричными операциями
# - strutils: для работы со строками
# - random: для генерации случайных чисел
# - math: для математических операций (round и др.)
import matrix_operations
import std/[strutils, random, math]

# Константы для информации о программе
const
  VERSION = "1.2"                     # Версия программы
  AUTHOR = "Nim Matrix Calculator"    # Автор/название программы


proc showMenu() =
  ## Отображает главное меню программы
  
  # Верхняя граница меню
  echo "=".repeat(60)  # Создаем строку из 60 знаков "="
  
  # Заголовок программы с версией
  echo "Калькулятор матриц v" & VERSION
  
  # Нижняя граница меню
  echo "=".repeat(60)
  
  # Список доступных операций
  echo "1. Сложение матриц"               
  echo "2. Умножение матриц"              
  echo "3. Транспонирование матрицы"      
  echo "4. Вычисление определителя"       
  echo "5. Создать случайную матрицу"     
  echo "6. Примеры матриц (для тестирования)" 
  echo "7. Создать единичную матрицу"     
  echo "8. Умножение матрицы на скаляр"   
  echo "0. Выход"                         
  
  # Разделитель
  echo "-".repeat(60)

proc createRandomMatrix(): Matrix =
  ## Создает случайную матрицу по параметрам от пользователя
  ## Возвращает случайно сгенерированную матрицу
  
  echo "=== Создание случайной матрицы ==="
  
  # Запрос количества строк
  echo "Введите количество строк:"
  let rowsStr = readLine(stdin).strip()  # Читаем ввод пользователя
  
  # Преобразуем в число с обработкой ошибок
  # Если преобразование не удалось, используем значение по умолчанию (2)
  let rows = try: 
    rowsStr.parseInt()  # Пытаемся преобразовать строку в целое число
  except: 
    2  # Значение по умолчанию в случае ошибки
  
  # Запрос количества столбцов (аналогично строкам)
  echo "Введите количество столбцов:"
  let colsStr = readLine(stdin).strip()
  let cols = try: 
    colsStr.parseInt() 
  except: 
    2  # Значение по умолчанию
  
  # Проверка корректности размеров
  if rows <= 0 or cols <= 0:
    echo "Используются значения по умолчанию: 2x2"
    return createRandomMatrix()  # Рекурсивный вызов с правильными параметрами
  
  # Инициализация генератора случайных чисел
  randomize()
  
  # Создаем матрицу нужного размера
  result = createMatrix(rows, cols)
  
  # Заполняем матрицу случайными числами от 1.0 до 10.0
  for i in 0..<rows:
    for j in 0..<cols:
      # Генерируем случайное число от 1.0 до 10.0
      let randomValue = rand(1.0..10.0)
      
      # Округляем до 2 знаков после запятой:
      # 1. Умножаем на 100: 1.2345 -> 123.45
      # 2. Округляем: 123.45 -> 123.0
      # 3. Делим на 100: 123.0 -> 1.23
      result[i][j] = round(randomValue * 100) / 100

proc showExamples() =
  ## Показывает примеры матриц для тестирования программы
  
  echo "=== Примеры матриц для тестирования ==="
  echo ""  # Пустая строка для читаемости
  
  # Пример 1: Матрица 2x2
  echo "1. Матрица 2x2:"
  let m1 = createMatrixFromArray(@[@[1.0, 2.0], @[3.0, 4.0]])
  printMatrix(m1)
  
  # Пример 2: Матрица 3x3
  echo "\n2. Матрица 3x3:"
  let m2 = createMatrixFromArray(@[
    @[1.0, 2.0, 3.0], 
    @[4.0, 5.0, 6.0], 
    @[7.0, 8.0, 9.0]
  ])
  printMatrix(m2)
  
  # Пример 3: Единичная матрица 3x3
  echo "\n3. Единичная матрица 3x3:"
  let m3 = getIdentityMatrix(3)
  printMatrix(m3)
  
  # Пауза для просмотра примеров
  echo "\nНажмите Enter для продолжения..."
  discard readLine(stdin)  # Игнорируем введенную строку

proc showHelp() =
  ## Показывает справку по формату ввода матриц
  
  echo "=== Справка по вводу матриц ==="
  
  # Основные правила ввода
  echo "1. Сначала введите количество строк"
  echo "2. Затем введите количество столбцов"
  echo "3. Вводите матрицу построчно"
  echo "4. В каждой строке введите числа через пробел"
  
  echo ""  # Пустая строка
  
  # Конкретный пример
  echo "Пример ввода матрицы 2x3:"
  echo "Количество строк: 2"
  echo "Количество столбцов: 3"
  echo "Строка 1: 1 2 3"
  echo "Строка 2: 4 5 6"
  
  echo ""  # Пустая строка
  
  # Пауза для чтения справки
  echo "Нажмите Enter для продолжения..."
  discard readLine(stdin)

proc createIdentityMatrix(): Matrix =
  ## Создает единичную матрицу по размеру от пользователя
  ## Возвращает: единичную матрицу указанного размера
  
  echo "=== Создание единичной матрицы ==="
  
  # Запрос размера матрицы
  echo "Введите размер матрицы (n x n):"
  let nStr = readLine(stdin).strip()
  
  # Преобразуем в число с обработкой ошибок
  let n = try: 
    nStr.parseInt() 
  except: 
    3  # Значение по умолчанию
  
  # Проверка корректности размера
  if n <= 0:
    echo "Размер должен быть положительным. Используется 3."
    result = getIdentityMatrix(3)  # Используем значение по умолчанию
  else:
    result = getIdentityMatrix(n)  # Создаем матрицу указанного размера
  
  # Показываем результат
  echo "Создана единичная матрица:"
  printMatrix(result)

proc multiplyByScalar(): Matrix =
  ## Умножает матрицу на скаляр (число)
  ## Возвращает: результат умножения
  
  echo "=== Умножение матрицы на скаляр ==="
  
  # Ввод матрицы
  echo "Введите матрицу:"
  let m = inputMatrix()
  
  # Показываем введенную матрицу
  echo "Введенная матрица:"
  printMatrix(m)
  
  # Ввод скаляра (числа-множителя)
  echo "Введите скаляр (число):"
  let scalarStr = readLine(stdin).strip()
  
  # Преобразуем в число с плавающей точкой
  let scalar = try: 
    scalarStr.parseFloat() 
  except: 
    2.0  # Значение по умолчанию
  
  # Выполняем умножение
  result = scalarMultiply(m, scalar)
  
  # Показываем результат
  echo "Результат умножения на " & formatFloat(scalar, ffDecimal, precision = 2) & ":"
  printMatrix(result)


proc main() =
  ## Главная функция программы - точка входа
  
  # Приветствие
  echo "Добро пожаловать в калькулятор матриц! (автор: " & AUTHOR & ")"
  echo "Для справки по вводу нажмите 'h' в главном меню"
  echo ""  # Пустая строка
  
  # Основной цикл программы
  while true:
    try:  # Блок try для обработки исключений
      # Показываем меню
      showMenu()
      
      # Запрос выбора операции
      echo "Выберите операцию (или 'h' для справки):"
      
      # Читаем выбор пользователя
      var choice = readLine(stdin).strip().toLowerAscii()  # Приводим к нижнему регистру
      
      # Обработка выбора пользователя (конструкция case)
      case choice
      
      # Вариант 0: Выход из программы
      of "0", "выход", "exit", "quit":
        echo "До свидания! Спасибо за использование калькулятора."
        break  # Выход из цикла while, завершение программы
      
      # Вариант h: Показать справку
      of "h", "help", "?", "справка":
        showHelp()
        continue  # Переходим к следующей итерации цикла
      
      # Вариант 1: Сложение матриц
      of "1":
        echo "=== Сложение матриц ==="
        
        # Ввод первой матрицы
        echo "Введите первую матрицу:"
        let m1 = inputMatrix()
        echo "Первая матрица:"
        printMatrix(m1)
        
        # Ввод второй матрицы
        echo "\nВведите вторую матрицу:"
        let m2 = inputMatrix()
        echo "Вторая матрица:"
        printMatrix(m2)
        
        # Выполнение сложения с обработкой ошибок
        try:
          let result = addMatrices(m1, m2)
          echo "\n✅ Результат сложения:"
          printMatrix(result)
        except ValueError as e:
          echo "\n❌ Ошибка: " & e.msg  # Вывод сообщения об ошибке
      
      # Вариант 2: Умножение матриц (аналогично сложению)
      of "2":
        echo "=== Умножение матриц ==="
        echo "Введите первую матрицу:"
        let m1 = inputMatrix()
        echo "Первая матрица:"
        printMatrix(m1)
        
        echo "\nВведите вторую матрицу:"
        let m2 = inputMatrix()
        echo "Вторая матрица:"
        printMatrix(m2)
        
        try:
          let result = multiplyMatrices(m1, m2)
          echo "\n✅ Результат умножения:"
          printMatrix(result)
        except ValueError as e:
          echo "\n❌ Ошибка: " & e.msg
      
      # Вариант 3: Транспонирование матрицы
      of "3":
        echo "=== Транспонирование матрицы ==="
        echo "Введите матрицу:"
        let m = inputMatrix()
        echo "\nИсходная матрица:"
        printMatrix(m)
        
        # Транспонирование (не требует обработки ошибок для корректных матриц)
        let result = transposeMatrix(m)
        echo "\n✅ Транспонированная матрица:"
        printMatrix(result)
      
      # Вариант 4: Вычисление определителя
      of "4":
        echo "=== Вычисление определителя ==="
        echo "Введите квадратную матрицу:"
        let m = inputMatrix()
        echo "\nИсходная матрица:"
        printMatrix(m)
        
        try:
          # Вычисление определителя
          let det = determinant(m)
          
          # Вывод результата с 6 знаками после запятой
          echo "\n✅ Определитель матрицы: " & formatFloat(det, ffDecimal, precision = 6)
          
          # Дополнительная информация о матрице
          if abs(det) < 1e-10:  # Если определитель очень близок к нулю
            echo "⚠️  Матрица вырожденная (определитель близок к нулю)"
          elif det == 0:  # Если определитель равен нулю
            echo "⚠️  Матрица вырожденная (определитель равен нулю)"
          
        except ValueError as e:
          echo "\n❌ Ошибка: " & e.msg
      
      # Вариант 5: Создание случайной матрицы
      of "5":
        echo "=== Создание случайной матрицы ==="
        try:
          let m = createRandomMatrix()
          echo "\n✅ Случайная матрица:"
          printMatrix(m)
        except Exception as e:
          echo "\n❌ Ошибка: " & e.msg
      
      # Вариант 6: Примеры матриц
      of "6":
        showExamples()
      
      # Вариант 7: Создание единичной матрицы
      of "7":
        let m = createIdentityMatrix()
        # Результат уже выведен внутри функции
      
      # Вариант 8: Умножение на скаляр
      of "8":
        let m = multiplyByScalar()
        # Результат уже выведен внутри функции
      
      # Неизвестный выбор
      else:
        echo "Неверный выбор. Попробуйте снова."
    
    # Обработка исключений
    except ValueError as e:  # Ошибки ввода данных
      echo "\n❌ Ошибка ввода: " & e.msg
    except Exception as e:  # Все остальные ошибки
      echo "\n❌ Неожиданная ошибка: " & e.msg
    
    # Пауза между операциями
    echo "\n" & "-".repeat(40)  # Разделитель
    echo "Нажмите Enter для продолжения..."
    discard readLine(stdin)  # Ожидание нажатия Enter


when isMainModule:
  ## Условная компиляция: этот код выполняется только если файл
  ## компилируется как основная программа, а не импортируется как модуль
  
  main()  # Запуск главной функции
